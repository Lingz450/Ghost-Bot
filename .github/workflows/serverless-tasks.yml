name: Serverless Tasks

on:
  schedule:
    - cron: "*/5 * * * *"
  workflow_dispatch:

jobs:
  run-tasks:
    runs-on: ubuntu-latest
    env:
      # Priority: GitHub Secret -> GitHub Variable -> production alias
      VERCEL_BASE_URL: ${{ secrets.VERCEL_BASE_URL || vars.VERCEL_BASE_URL || 'https://ghost-bot-ashen.vercel.app' }}
      CRON_SECRET: ${{ secrets.CRON_SECRET || vars.CRON_SECRET || '' }}
    steps:
      - name: Validate base URL
        run: |
          if [ -z "${VERCEL_BASE_URL}" ]; then
            echo "Missing VERCEL_BASE_URL (set secret/variable), and no fallback URL available."
            exit 1
          fi
          echo "Using base URL: ${VERCEL_BASE_URL}"

      - name: Health check
        shell: bash
        run: |
          set -euo pipefail
          BASE="${VERCEL_BASE_URL%/}"
          code=$(curl -sS -o /tmp/health.txt -w "%{http_code}" "${BASE}/health")
          cat /tmp/health.txt
          echo ""
          if [ "$code" -ge 400 ]; then
            echo "Health check failed with HTTP $code"
            exit 1
          fi

      - name: Run alerts task
        shell: bash
        run: |
          set -euo pipefail
          BASE="${VERCEL_BASE_URL%/}"
          if [ -n "${CRON_SECRET}" ]; then
            code=$(curl -sS -o /tmp/alerts.txt -w "%{http_code}" -X POST -H "Authorization: Bearer ${CRON_SECRET}" "${BASE}/tasks/alerts/run")
          else
            code=$(curl -sS -o /tmp/alerts.txt -w "%{http_code}" -X POST "${BASE}/tasks/alerts/run")
          fi
          cat /tmp/alerts.txt
          echo ""
          if [ "$code" -ge 400 ]; then
            echo "WARNING: alerts task failed with HTTP $code"
          fi

      - name: Run giveaways task
        shell: bash
        run: |
          set -euo pipefail
          BASE="${VERCEL_BASE_URL%/}"
          if [ -n "${CRON_SECRET}" ]; then
            code=$(curl -sS -o /tmp/giveaways.txt -w "%{http_code}" -X POST -H "Authorization: Bearer ${CRON_SECRET}" "${BASE}/tasks/giveaways/run")
          else
            code=$(curl -sS -o /tmp/giveaways.txt -w "%{http_code}" -X POST "${BASE}/tasks/giveaways/run")
          fi
          cat /tmp/giveaways.txt
          echo ""
          if [ "$code" -ge 400 ]; then
            echo "WARNING: giveaways task failed with HTTP $code"
          fi

      - name: Refresh RSI market scan
        shell: bash
        run: |
          set -euo pipefail
          BASE="${VERCEL_BASE_URL%/}"
          if [ -n "${CRON_SECRET}" ]; then
            code=$(curl -sS -o /tmp/rsi.txt -w "%{http_code}" -X POST -H "Authorization: Bearer ${CRON_SECRET}" "${BASE}/tasks/rsi/refresh")
          else
            code=$(curl -sS -o /tmp/rsi.txt -w "%{http_code}" -X POST "${BASE}/tasks/rsi/refresh")
          fi
          cat /tmp/rsi.txt
          echo ""
          if [ "$code" -ge 400 ]; then
            echo "WARNING: rsi refresh task failed with HTTP $code"
          fi

      - name: Run news warm task every 15 minutes
        shell: bash
        run: |
          set -euo pipefail
          MINUTE=$(date -u +%M)
          MOD=$((10#$MINUTE % 15))
          if [ "$MOD" -eq 0 ]; then
            BASE="${VERCEL_BASE_URL%/}"
            if [ -n "${CRON_SECRET}" ]; then
              code=$(curl -sS -o /tmp/news.txt -w "%{http_code}" -X POST -H "Authorization: Bearer ${CRON_SECRET}" "${BASE}/tasks/news/warm")
            else
              code=$(curl -sS -o /tmp/news.txt -w "%{http_code}" -X POST "${BASE}/tasks/news/warm")
            fi
            cat /tmp/news.txt
            echo ""
            if [ "$code" -ge 400 ]; then
              echo "WARNING: news warm task failed with HTTP $code"
            fi
          else
            echo "Skipping news warm this run (minute=$MINUTE)"
          fi
